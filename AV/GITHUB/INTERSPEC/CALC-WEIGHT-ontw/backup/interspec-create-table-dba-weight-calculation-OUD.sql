--Create hulptabel voor test-werkzaamheden:  interspc.DBA_WEIGHT_CALCULATION
--

--dbms_output.put_line(l_part_no||';'||l_path||';'||l_quantity_path||';'||l_quantity_kg||';'||l_excl_quantity_kg ||';'||l_uom );
--
CREATE SEQUENCE  INTERSPC.DBA_WEIGHT_CALC_SEQ  MINVALUE 0 MAXVALUE 9999999999 INCREMENT BY 1 START WITH 1 NOCACHE  NOORDER  NOCYCLE ;


--tabel wordt gevuld met main-part-no (meestal de band, of vulcanized-tyre, maar kan ook een part-no zijn waar nog component-materialen onderzitten.
DROP TABLE INTERSPC.DBA_WEIGHT_CALCULATION CASCADE CONSTRAINTS;
--
CREATE table INTERSPC.DBA_WEIGHT_CALCULATION
(id                    number         NOT NULL
,tech_calculation_date date
,main_part_no          VARCHAR2(18 CHAR)
,part_no               VARCHAR2(18 CHAR)
,component_part_no     VARCHAR2(18 CHAR)
,characteristic_id     number
,path                  varchar2(4000)
,quantity_path         varchar2(4000)
,quantity_kg           number
,excl_quantity_kg      number
,uom                   varchar2(10)
,remark                varchar2(4000)
)
TABLESPACE SPECD;

--PK
alter table INTERSPC.DBA_WEIGHT_CALCULATION DROP CONSTRAINT PK_WEIGHT_CALC_ID ;
--
ALTER TABLE INTERSPC.DBA_WEIGHT_CALCULATION ADD CONSTRAINT PK_WEIGHT_CALC_ID PRIMARY KEY (ID)
USING INDEX
TABLESPACE SPECI ;

--uk
alter table drop constraint INTERSPC.UK_WEIGHT_CALC_PART_NO;
drop index INTERSPC.UK_WEIGHT_CALC_PART_NO;
--
create unique index INTERSPC.UK_WEIGHT_CALC_PART_NO  ON INTERSPC.DBA_WEIGHT_CALCULATION (MAIN_PART_NO, PART_NO, COMPONENT_PART_NO, CHARACTERISTIC_ID, PATH)
TABLESPACE SPECI
;
--

--trigger
--drop trigger DBA_WEIGHT_CALCULATION_BRIU;
--
create or replace TRIGGER DBA_WEIGHT_CALCULATION_BRI
BEFORE INSERT ON INTERSPC.DBA_WEIGHT_CALCULATION
REFERENCING NEW AS New OLD AS Old
FOR EACH ROW
BEGIN
  if :new.id is null
  then select dba_weight_calc_seq.nextval into :new.id from dual;
  end if;
  if :new.tech_calculation_date is null
  then :new.tech_calculation_date := sysdate;
  end if;
  --
END;
/

--AUTONOMOUS-procedure voor inserten van WEIGH-CALCULATION:

create or replace procedure DBA_INSERT_WEIGHT_CALC (p_main_part_no     varchar2
                                 ,p_part_no           varchar2
								 ,p_component_part_no varchar2
								 ,p_characteristic_id number
								 ,p_path              varchar2
								 ,p_quantity_path     varchar2
								 ,p_quantity_kg       number
								 ,p_excl_quantity_kg  number
								 ,p_uom               varchar2
								 ,p_remark            varchar2 ) 
is
pragma autonomous_transaction;
l_calc_date   date;
begin
  --
  l_calc_date := sysdate;
  --
  insert into DBA_WEIGHT_CALCULATION
  (tech_calculation_date 
  ,main_part_no          
  ,part_no   
  ,component_part_no  
  ,characteristic_id
  ,path                  
  ,quantity_path         
  ,quantity_kg           
  ,excl_quantity_kg      
  ,uom                   
  ,remark  
  )
  values
  (l_calc_date
  ,p_main_part_no     
  ,p_part_no         
  ,p_component_part_no  
  ,p_characteristic_id
  ,p_path             
  ,p_quantity_path    
  ,p_quantity_kg      
  ,p_excl_quantity_kg 
  ,p_uom              
  ,p_remark 
  )
  ;
  --
  commit;
exception
  when others
  then dbms_output.put_line('DBA-INSERT-WEIGHT-CALC-ALG-EXCP-ERROR: '||sqlerrm);
       null;
end;
/

--testen van een MAIN-PART-NO:
DECLARE
  P_HEADER_PART_NO VARCHAR2(200) ;
  P_HEADER_SAP_CODE VARCHAR2(200);
  P_SHOW_INCL_ITEMS_JN VARCHAR2(200);
BEGIN
  P_HEADER_PART_NO := 'EF_Y245/35R20QPRX' ;
  P_HEADER_SAP_CODE := NULL;
  P_SHOW_INCL_ITEMS_JN := 'J';

  DBA_BEPAAL_BOM_GEWICHT(
    P_HEADER_PART_NO => P_HEADER_PART_NO,
    P_HEADER_SAP_CODE => P_HEADER_SAP_CODE,
    P_SHOW_INCL_ITEMS_JN => P_SHOW_INCL_ITEMS_JN
  );
--rollback; 
END;

/*
DBA-INSERT-WEIGHT-CALC-ALG-EXCP-ERROR: ORA-00001: unique constraint (INTERSPC.UK_WEIGHT_CALC_PART_NO) violated
EM_422;|EF_Y245/35R20QPRX,EV_BY245/35R20QPRX|EV_BY245/35R20QPRX,EG_BY243520QPRX-G|EG_BY243520QPRX-G,ET_LV634|ET_LV634,EM_722|EM_722,EM_522|EM_522,EM_422|EM_422,GR_2134;*(1/1)*(1/1)*(2.026537/1)*(.295597/1)*(1.0963185/1.129025)*(1.1229619/1.122962)*(.3151909/1.1239581);.3151909;.16312151780162661572195843545462109099;kg
DBA-INSERT-WEIGHT-CALC-ALG-EXCP-ERROR: ORA-00001: unique constraint (INTERSPC.UK_WEIGHT_CALC_PART_NO) violated
EM_422;|EF_Y245/35R20QPRX,EV_BY245/35R20QPRX|EV_BY245/35R20QPRX,EG_BY243520QPRX-G|EG_BY243520QPRX-G,ET_LV634|ET_LV634,EM_722|EM_722,EM_522|EM_522,EM_422|EM_422,GR_2212;*(1/1)*(1/1)*(2.026537/1)*(.295597/1)*(1.0963185/1.129025)*(1.1229619/1.122962)*(.033531/1.1239581);.033531;.017353380485941510531468352351634834007;kg
DBA-INSERT-WEIGHT-CALC-ALG-EXCP-ERROR: ORA-00001: unique constraint (INTERSPC.UK_WEIGHT_CALC_PART_NO) violated
EM_422;|EF_Y245/35R20QPRX,EV_BY245/35R20QPRX|EV_BY245/35R20QPRX,EG_BY243520QPRX-G|EG_BY243520QPRX-G,ET_LV634|ET_LV634,EM_722|EM_722,EM_522|EM_522,EM_422|EM_422,GR_3511;*(1/1)*(1/1)*(2.026537/1)*(.295597/1)*(1.0963185/1.129025)*(1.1229619/1.122962)*(.0234717/1.1239581);.0234717;.012147366340159057372027846646144383805;kg
DBA-INSERT-WEIGHT-CALC-ALG-EXCP-ERROR: ORA-00001: unique constraint (INTERSPC.UK_WEIGHT_CALC_PART_NO) violated
EM_422;|EF_Y245/35R20QPRX,EV_BY245/35R20QPRX|EV_BY245/35R20QPRX,EG_BY243520QPRX-G|EG_BY243520QPRX-G,ET_LV634|ET_LV634,EM_722|EM_722,EM_522|EM_522,EM_422|EM_422,GR_4312;*(1/1)*(1/1)*(2.026537/1)*(.295597/1)*(1.0963185/1.129025)*(1.1229619/1.122962)*(.0268248/1.1239581);.0268248;.013882704388753208425174681881307867206;kg
DBA-INSERT-WEIGHT-CALC-ALG-EXCP-ERROR: ORA-00001: unique constraint (INTERSPC.UK_WEIGHT_CALC_PART_NO) violated
EM_422;|EF_Y245/35R20QPRX,EV_BY245/35R20QPRX|EV_BY245/35R20QPRX,EG_BY243520QPRX-G|EG_BY243520QPRX-G,ET_LV634|ET_LV634,EM_722|EM_722,EM_522|EM_522,EM_422|EM_422,GR_4321;*(1/1)*(1/1)*(2.026537/1)*(.295597/1)*(1.0963185/1.129025)*(1.1229619/1.122962)*(.0134124/1.1239581);.0134124;.006941352194376604212587340940653933603;kg
DBA-INSERT-WEIGHT-CALC-ALG-EXCP-ERROR: ORA-00001: unique constraint (INTERSPC.UK_WEIGHT_CALC_PART_NO) violated
EM_422;|EF_Y245/35R20QPRX,EV_BY245/35R20QPRX|EV_BY245/35R20QPRX,EG_BY243520QPRX-G|EG_BY243520QPRX-G,ET_LV634|ET_LV634,EM_722|EM_722,EM_522|EM_522,EM_422|EM_422,GR_4611;*(1/1)*(1/1)*(2.026537/1)*(.295597/1)*(1.0963185/1.129025)*(1.1229619/1.122962)*(.0134124/1.1239581);.0134124;.006941352194376604212587340940653933603;kg
DBA-INSERT-WEIGHT-CALC-ALG-EXCP-ERROR: ORA-00001: unique constraint (INTERSPC.UK_WEIGHT_CALC_PART_NO) violated
EM_422;|EF_Y245/35R20QPRX,EV_BY245/35R20QPRX|EV_BY245/35R20QPRX,EG_BY243520QPRX-G|EG_BY243520QPRX-G,ET_LV634|ET_LV634,EM_722|EM_722,EM_522|EM_522,EM_422|EM_422,GR_4651;*(1/1)*(1/1)*(2.026537/1)*(.295597/1)*(1.0963185/1.129025)*(1.1229619/1.122962)*(.005365/1.1239581);.005365;.002776561579048528346942462508321281335;kg
DBA-INSERT-WEIGHT-CALC-ALG-EXCP-ERROR: ORA-00001: unique constraint (INTERSPC.UK_WEIGHT_CALC_PART_NO) violated
EM_422;|EF_Y245/35R20QPRX,EV_BY245/35R20QPRX|EV_BY245/35R20QPRX,EG_BY243520QPRX-G|EG_BY243520QPRX-G,ET_LV634|ET_LV634,EM_722|EM_722,EM_522|EM_522,EM_422|EM_422,GR_4711;*(1/1)*(1/1)*(2.026537/1)*(.295597/1)*(1.0963185/1.129025)*(1.1229619/1.122962)*(.0067062/1.1239581);.0067062;.003470676097188302106293670470326966801;kg
DBA-INSERT-WEIGHT-CALC-ALG-EXCP-ERROR: ORA-00001: unique constraint (INTERSPC.UK_WEIGHT_CALC_PART_NO) violated
EM_422;|EF_Y245/35R20QPRX,EV_BY245/35R20QPRX|EV_BY245/35R20QPRX,EG_BY243520QPRX-G|EG_BY243520QPRX-G,ET_LV634|ET_LV634,EM_722|EM_722,EM_522|EM_522,EM_422|EM_422,GR_5112;*(1/1)*(1/1)*(2.026537/1)*(.295597/1)*(1.0963185/1.129025)*(1.1229619/1.122962)*(.0134124/1.1239581);.0134124;.006941352194376604212587340940653933603;kg
DBA-INSERT-WEIGHT-CALC-ALG-EXCP-ERROR: ORA-00001: unique constraint (INTERSPC.UK_WEIGHT_CALC_PART_NO) violated
EM_422;|EF_Y245/35R20QPRX,EV_BY245/35R20QPRX|EV_BY245/35R20QPRX,EG_BY243520QPRX-G|EG_BY243520QPRX-G,ET_LV634|ET_LV634,EM_722|EM_722,EM_522|EM_522,EM_422|EM_422,GR_5214;*(1/1)*(1/1)*(2.026537/1)*(.295597/1)*(1.0963185/1.129025)*(1.1229619/1.122962)*(.0020119/1.1239581);.0020119;.001041223530454377293795627273157797934;kg
DBA-INSERT-WEIGHT-CALC-ALG-EXCP-ERROR: ORA-00001: unique constraint (INTERSPC.UK_WEIGHT_CALC_PART_NO) violated
EM_722;|EF_Y245/35R20QPRX,EV_BY245/35R20QPRX|EV_BY245/35R20QPRX,EG_BY243520QPRX-G|EG_BY243520QPRX-G,ET_LV634|ET_LV634,EM_722|EM_722,GR_4121;*(1/1)*(1/1)*(2.026537/1)*(.295597/1)*(.0130826/1.129025);.0130826;.006941367913672284847545448506454684352;kg
DBA-INSERT-WEIGHT-CALC-ALG-EXCP-ERROR: ORA-00001: unique constraint (INTERSPC.UK_WEIGHT_CALC_PART_NO) violated
EM_722;|EF_Y245/35R20QPRX,EV_BY245/35R20QPRX|EV_BY245/35R20QPRX,EG_BY243520QPRX-G|EG_BY243520QPRX-G,ET_LV634|ET_LV634,EM_722|EM_722,GR_4211;*(1/1)*(1/1)*(2.026537/1)*(.295597/1)*(.0124284/1.129025);.0124284;.006594262377377939018179402581873740617;kg
DBA-INSERT-WEIGHT-CALC-ALG-EXCP-ERROR: ORA-00001: unique constraint (INTERSPC.UK_WEIGHT_CALC_PART_NO) violated
EM_722;|EF_Y245/35R20QPRX,EV_BY245/35R20QPRX|EV_BY245/35R20QPRX,EG_BY243520QPRX-G|EG_BY243520QPRX-G,ET_LV634|ET_LV634,EM_722|EM_722,GR_4244;*(1/1)*(1/1)*(2.026537/1)*(.295597/1)*(.0065413/1.129025);.0065413;.003470683956836142423772724253227342176;kg
DBA-INSERT-WEIGHT-CALC-ALG-EXCP-ERROR: ORA-00001: unique constraint (INTERSPC.UK_WEIGHT_CALC_PART_NO) violated
EM_722;|EF_Y245/35R20QPRX,EV_BY245/35R20QPRX|EV_BY245/35R20QPRX,EG_BY243520QPRX-G|EG_BY243520QPRX-G,ET_LV634|ET_LV634,EM_722|EM_722,GR_4411;*(1/1)*(1/1)*(2.026537/1)*(.295597/1)*(.0006541/1.129025);.0006541;.000347052478279014990810655211354930139;kg
DBA-INSERT-WEIGHT-CALC-ALG-EXCP-ERROR: ORA-00001: unique constraint (INTERSPC.UK_WEIGHT_CALC_PART_NO) violated
--
-- dit is wel vreemd:
-- Hoe kan het we 2x zelfde partno/componenten tegenkomen vanuit hetzelfde PATH als een vorige ... ???
*/





--Uitvragen VAN DBA_WEIGHT_CALCULATION-tabel:

SELECT part_no, substr(path,1,instr(path,'|',-1)), sum(quantity_kg) , sum(excl_quantity_kg) 
FROM DBA_WEIGHT_CALCULATION 
WHERE main_part_no = 'EF_Y245/35R20QPRX'    --EV_BY245/35R20QPRX
group by part_no, substr(path,1,instr(path,'|',-1))
order by part_no, substr(path,1,instr(path,'|',-1))
;


SELECT sum(quantity_kg), sum(excl_quantity_kg) 
FROM DBA_WEIGHT_CALCULATION 
WHERE main_part_no = 'EF_Y245/35R20QPRX'    --EV_BY245/35R20QPRX
;
/*
22.5297379	11.49179848584842259749816169411974386529
--
--DIT LIJKT WEL HET GOEDE RESULTAAT TE ZIJN !!!!!!
*/
SELECT sum(quantity_kg), sum(excl_quantity_kg), sum(decode(uom,'pcs',0,quantity_kg)), sum(decode(uom,'pcs',0,excl_quantity_kg)) 
FROM DBA_WEIGHT_CALCULATION 
WHERE main_part_no = 'EF_Y245/35R20QPRX'
;
/*
22.5297379	11.49179848584842259749816169411974386529	21.5297379	10.49179848584842259749816169411974386529
--
--CONCLUSIE: NU KOMT GEWICHT OP HETZELFDE UIT ALS DE VULCANIZED-TYRE. ECHTER NOG NIET HETZELFDE ALS IN AS400-XLS, MAAR KOMT WAARSCHIJNLIJK DOOR DUBBELE COMPONENT-PART-NO !!!!
--
*/



SELECT sum(quantity_kg), sum(excl_quantity_kg) 
FROM DBA_WEIGHT_CALCULATION 
WHERE main_part_no = 'EV_BY245/35R20QPRX'   --'EF_Y245/35R20QPRX'
;

SELECT sum(quantity_kg), sum(excl_quantity_kg), sum(decode(uom,'pcs',0,quantity_kg)), sum(decode(uom,'pcs',0,excl_quantity_kg)) 
FROM DBA_WEIGHT_CALCULATION 
WHERE main_part_no = 'EV_BY245/35R20QPRX'   --'EF_Y245/35R20QPRX'
;


PROMPT EINDE SCRIPT






           