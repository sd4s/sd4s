CREATE OR REPLACE PROCEDURE SP_NOTE_HISTORY(
   AS_PART_NO                          VARCHAR2 )
IS













   L_TODAY                       DATE;
   LSSOURCE                      IAPITYPE.SOURCE_TYPE := 'SP_NOTE_HISTORY';
   LNRETVAL                      IAPITYPE.ERRORNUM_TYPE;

   CURSOR CUR_TEXT
   IS
      SELECT TEXT
        FROM ITPRNOTE
       WHERE PART_NO = AS_PART_NO;
BEGIN
   IF IAPIGENERAL.SESSION.APPLICATIONUSER.USERID IS NULL
   THEN
      LNRETVAL := IAPIGENERAL.SETERRORTEXT( IAPICONSTANTDBERROR.DBERR_NOINITSESSION );
      IAPIGENERAL.LOGERROR( LSSOURCE,
                            '',
                            IAPIGENERAL.GETLASTERRORTEXT( ) );
      RAISE_APPLICATION_ERROR( -20000,
                               IAPIGENERAL.GETLASTERRORTEXT( ) );
   END IF;

   L_TODAY := SYSDATE;

   BEGIN
      INSERT INTO ITSH_H
                  ( PART_NO,
                    LAST_MODIFIED_ON )
           VALUES ( AS_PART_NO,
                    L_TODAY );
   EXCEPTION
      WHEN DUP_VAL_ON_INDEX
      THEN
         UPDATE ITSH_H
            SET LAST_MODIFIED_ON = SYSDATE
          WHERE PART_NO = AS_PART_NO;
   END;

   
   
   BEGIN
   
   INSERT INTO ITPRNOTE_H
               ( PART_NO,
                 LAST_MODIFIED_ON,
                 LAST_MODIFIED_BY,
                 FORENAME,
                 LAST_NAME )
        VALUES ( AS_PART_NO,
                 L_TODAY,
                 IAPIGENERAL.SESSION.APPLICATIONUSER.USERID,
                 IAPIGENERAL.SESSION.APPLICATIONUSER.FORENAME,
                 IAPIGENERAL.SESSION.APPLICATIONUSER.LASTNAME );

   
   EXCEPTION
      WHEN DUP_VAL_ON_INDEX
      THEN
         UPDATE ITPRNOTE_H
            SET LAST_MODIFIED_BY = IAPIGENERAL.SESSION.APPLICATIONUSER.USERID,
                FORENAME = IAPIGENERAL.SESSION.APPLICATIONUSER.FORENAME,
                LAST_NAME = IAPIGENERAL.SESSION.APPLICATIONUSER.LASTNAME            
          WHERE PART_NO = AS_PART_NO
            AND LAST_MODIFIED_ON = L_TODAY; 
   END;   
   

   FOR REC_TEXT IN CUR_TEXT
   LOOP
      UPDATE ITPRNOTE_H
         SET TEXT = REC_TEXT.TEXT
       WHERE PART_NO = AS_PART_NO
         AND LAST_MODIFIED_ON = L_TODAY;
   END LOOP;
EXCEPTION
   WHEN OTHERS
   THEN
      IAPIGENERAL.LOGERROR( LSSOURCE,
                            '',
                            SQLERRM );
      LNRETVAL := IAPIGENERAL.SETERRORTEXT( IAPICONSTANTDBERROR.DBERR_GENFAIL );
      RAISE_APPLICATION_ERROR( -20000,
                               IAPIGENERAL.GETLASTERRORTEXT( ) );
END;