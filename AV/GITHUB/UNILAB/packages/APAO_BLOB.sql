CREATE OR REPLACE PACKAGE        APAO_BLOB AS
--------------------------------------------------------------------------------
--  PROJECT : Vredestein Enschede
-------------------------------------------------------------------------------
--  PACKAGE : APAO_BLOB
-- ABSTRACT :
--   WRITER : Rody Sparenberg
--     DATE : 02/04/2009
--   TARGET : Oracle 10.2.0 / Unilab 6.1 sp1
--  VERSION : av2.0
--------------------------------------------------------------------------------
--  REMARKS :
--------------------------------------------------------------------------------
--  CHANGES :
--
--  When      | Who       | What
--============|===========|=====================================================
-- 07/05/2009 | RS        | Created
--------------------------------------------------------------------------------

--------------------------------------------------------------------------------
-- Types
--------------------------------------------------------------------------------

--------------------------------------------------------------------------------
-- Constants
--------------------------------------------------------------------------------

--------------------------------------------------------------------------------
-- Cursors
--------------------------------------------------------------------------------

--------------------------------------------------------------------------------
-- Variables
--------------------------------------------------------------------------------

--------------------------------------------------------------------------------
-- functions- and/or procedures-declarations
--------------------------------------------------------------------------------

FUNCTION WRITEBLOB(avs_ID            VARCHAR2)
RETURN VARCHAR2;

END APAO_BLOB;

/


CREATE OR REPLACE PACKAGE BODY        APAO_BLOB AS
--------------------------------------------------------------------------------
--  PROJECT : Vredestein Enschede
-------------------------------------------------------------------------------
--  PACKAGE : APAO_BLOB
-- ABSTRACT :
--   WRITER : Rody Sparenberg
--     DATE : 02/04/2009
--   TARGET : Oracle 10.2.0 / Unilab 6.1 sp1
--  VERSION : av2.0
--------------------------------------------------------------------------------
--  REMARKS :
--------------------------------------------------------------------------------
--  CHANGES :
--
--  When      | Who       | What
--============|===========|=====================================================
-- 07/05/2009 | RS        | Created
--------------------------------------------------------------------------------

--------------------------------------------------------------------------------
-- Types
--------------------------------------------------------------------------------

--------------------------------------------------------------------------------
-- Constants
--------------------------------------------------------------------------------
ics_package_name                 CONSTANT VARCHAR2(20) := 'APAO_BLOB';
--------------------------------------------------------------------------------
-- Cursors
--------------------------------------------------------------------------------

--------------------------------------------------------------------------------
-- Variables
--------------------------------------------------------------------------------

--------------------------------------------------------------------------------
-- functions- and/or procedures-declarations
--------------------------------------------------------------------------------
PROCEDURE exportBLOB (p_blob IN blob, p_file IN varchar2) AS
 language java name 'aopa_Blob.do_export(oracle.sql.BLOB,
 java.lang.String)';

FUNCTION WRITEBLOB(avs_ID            VARCHAR2)
RETURN VARCHAR2 IS

   l_description  VARCHAR2(2000);
   lvi_ret_code   APAOGEN.RETURN_TYPE;

CURSOR lvq_blob IS
   SELECT a.*, 'D:\\Images\\bo_temp\' || substr(a.url, instr(a.url,'\',-1)) filename
     FROM utblob a
    WHERE a.id = avs_ID;
BEGIN

   FOR lvr_blob IN lvq_blob LOOP

      /* EXECUTE AS SYS :
      BEGIN
         DBMS_JAVA.GRANT_PERMISSION('UNILAB','SYS:java.io.FilePermission','D:\Images\bo_temp*','write');
      END;
      */
      exportBLOB ( lvr_blob.data, lvr_blob.filename);

      l_description := lvr_blob.filename;
   END LOOP;

   RETURN l_description;

EXCEPTION
  WHEN OTHERS THEN
    RETURN SQLERRM;

END WRITEBLOB;

END APAO_BLOB;
/
