PACKAGE BODY unapievstat AS

FUNCTION GETVERSION
   RETURN VARCHAR2
IS
BEGIN
   RETURN('06.07.00.00_00.13');
EXCEPTION
   WHEN OTHERS THEN
      RETURN (NULL);
END GETVERSION;

FUNCTION COLLECTSTAT4LCTRANSITIONS 
RETURN NUMBER IS
BEGIN
   BEGIN
      UPDATE UTEVSTAT
            SET LC_TRANS=LC_TRANS
            WHERE EV_CLIENT_ID  = NVL(UNAPIEV.P_EV_REC.CLIENT_ID, '-') 
              AND EV_APPLIC     = NVL(UNAPIEV.P_EV_REC.APPLIC, '-')
              AND EV_DBAPI_NAME = NVL(UNAPIEV.P_EV_REC.DBAPI_NAME, '-')
              AND EV_EVMGR_NAME = NVL(UNAPIEV.P_EV_REC.EVMGR_NAME, '-')       
              AND EV_OBJECT_TP  = NVL(UNAPIEV.P_EV_REC.OBJECT_TP, '-')       
              AND EV_OBJECT_ID  = NVL(UNAPIEV.P_EV_REC.OBJECT_ID, '-')       
              AND NVL(EV_OBJECT_LC, '-')  = NVL(UNAPIEV.P_EV_REC.OBJECT_LC , '-')      
              AND NVL(EV_OBJECT_LC_VERSION, '-') = NVL(UNAPIEV.P_EV_REC.OBJECT_LC_VERSION , '-')
              AND NVL(EV_OBJECT_SS, '-')  = NVL(UNAPIEV.P_EV_REC.OBJECT_SS  , '-')      
              AND EV_EV_TP      = NVL(UNAPIEV.P_EV_REC.EV_TP, '-') 
              AND LC_OBJECT_TP  = NVL(UNAPIEV.P_EV_REC.OBJECT_TP, '-')    
              AND LC_OBJECT_ID  = NVL(UNAPIEV.P_EV_REC.OBJECT_ID, '-') 
              AND NVL(LC_OBJECT_LC, '-')  = NVL(UNAPIEV.P_EV_REC.OBJECT_LC, '-');
      IF SQL%ROWCOUNT=0 THEN
         INSERT INTO UTEVSTAT 
         (EV_CLIENT_ID, EV_APPLIC, EV_DBAPI_NAME,
          EV_EVMGR_NAME, EV_OBJECT_TP, EV_OBJECT_ID,
          EV_OBJECT_LC, EV_OBJECT_LC_VERSION,
          EV_OBJECT_SS, EV_EV_TP, LC_OBJECT_TP,
          LC_OBJECT_ID, LC_OBJECT_LC,
          LC_TRANS, LC_EV_RULE_EXEC)
         VALUES
         (NVL(UNAPIEV.P_EV_REC.CLIENT_ID, '-'),NVL(UNAPIEV.P_EV_REC.APPLIC, '-'),
          NVL(UNAPIEV.P_EV_REC.DBAPI_NAME, '-'), NVL(UNAPIEV.P_EV_REC.EVMGR_NAME, '-'),
          NVL(UNAPIEV.P_EV_REC.OBJECT_TP, '-'), NVL(UNAPIEV.P_EV_REC.OBJECT_ID, '-'),
          NVL(UNAPIEV.P_EV_REC.OBJECT_LC , '-'), NVL(UNAPIEV.P_EV_REC.OBJECT_LC_VERSION , '-'), 
          NVL(UNAPIEV.P_EV_REC.OBJECT_SS  , '-'), NVL(UNAPIEV.P_EV_REC.EV_TP, '-'),  
          NVL(UNAPIEV.P_EV_REC.OBJECT_TP, '-'),
          NVL(UNAPIEV.P_EV_REC.OBJECT_ID, '-'), NVL(UNAPIEV.P_EV_REC.OBJECT_LC, '-'), 0, 0);
      END IF;
   EXCEPTION
   WHEN DUP_VAL_ON_INDEX THEN
      NULL;
   END;
   IF UNAPIEV.P_EV_TR_COUNT>0 THEN
      FOR L_X IN 1..UNAPIEV.P_EV_TR_COUNT LOOP
         UPDATE UTEVSTAT
         SET LC_TRANS=LC_TRANS+1
         WHERE EV_CLIENT_ID  = NVL(UNAPIEV.P_EV_REC.CLIENT_ID, '-')
           AND EV_APPLIC     = NVL(UNAPIEV.P_EV_REC.APPLIC, '-')
           AND EV_DBAPI_NAME = NVL(UNAPIEV.P_EV_REC.DBAPI_NAME, '-')
           AND EV_EVMGR_NAME = NVL(UNAPIEV.P_EV_REC.EVMGR_NAME, '-')
           AND EV_OBJECT_TP  = NVL(UNAPIEV.P_EV_REC.OBJECT_TP, '-')
           AND EV_OBJECT_ID  = NVL(UNAPIEV.P_EV_REC.OBJECT_ID, '-')
           AND NVL(EV_OBJECT_LC, '-')  = NVL(UNAPIEV.P_EV_REC.OBJECT_LC, '-')      
           AND NVL(EV_OBJECT_LC_VERSION, '-') = NVL(UNAPIEV.P_EV_REC.OBJECT_LC_VERSION , '-')
           AND NVL(EV_OBJECT_SS, '-')  = NVL(UNAPIEV.P_EV_REC.OBJECT_SS  , '-')      
           AND EV_EV_TP      = NVL(UNAPIEV.P_EV_REC.EV_TP, '-')
           AND LC_OBJECT_TP  = NVL(UNAPIEV.P_EV_TR(L_X).TP, '-')
           AND LC_OBJECT_ID  = NVL(UNAPIEV.P_EV_TR(L_X).ID, '-')
           AND NVL(LC_OBJECT_LC, '-')  = NVL(UNAPIEV.P_EV_TR(L_X).LC, '-');
        IF SQL%ROWCOUNT = 0 THEN
           INSERT INTO UTEVSTAT 
           (EV_CLIENT_ID, EV_APPLIC, EV_DBAPI_NAME,
            EV_EVMGR_NAME, EV_OBJECT_TP, EV_OBJECT_ID,
            EV_OBJECT_LC, EV_OBJECT_LC_VERSION,
            EV_OBJECT_SS, EV_EV_TP, LC_OBJECT_TP,
            LC_OBJECT_ID, LC_OBJECT_LC,
            LC_TRANS, LC_EV_RULE_EXEC)
           VALUES
           (NVL(UNAPIEV.P_EV_REC.CLIENT_ID, '-'),NVL(UNAPIEV.P_EV_REC.APPLIC, '-'),
            NVL(UNAPIEV.P_EV_REC.DBAPI_NAME, '-'), NVL(UNAPIEV.P_EV_REC.EVMGR_NAME, '-'),
            NVL(UNAPIEV.P_EV_REC.OBJECT_TP, '-'), NVL(UNAPIEV.P_EV_REC.OBJECT_ID, '-'), 
            NVL(UNAPIEV.P_EV_REC.OBJECT_LC , '-'), NVL(UNAPIEV.P_EV_REC.OBJECT_LC_VERSION , '-'), 
            NVL(UNAPIEV.P_EV_REC.OBJECT_SS  , '-'), NVL(UNAPIEV.P_EV_REC.EV_TP, '-'),  NVL(UNAPIEV.P_EV_TR(L_X).TP, '-'),
            NVL(UNAPIEV.P_EV_TR(L_X).ID , '-'), NVL(UNAPIEV.P_EV_TR(L_X).LC, '-'), 0, 0);
        END IF;
     END LOOP;
  END IF;
  RETURN(0);
END COLLECTSTAT4LCTRANSITIONS;

FUNCTION COLLECTSTAT4EVRULEEXECUTION 
RETURN NUMBER IS
BEGIN
         UPDATE UTEVSTAT
         SET LC_EV_RULE_EXEC=LC_EV_RULE_EXEC+1
         WHERE EV_CLIENT_ID  = NVL(UNAPIEV.P_EV_REC.CLIENT_ID, '-')
           AND EV_APPLIC     = NVL(UNAPIEV.P_EV_REC.APPLIC, '-')
           AND EV_DBAPI_NAME = NVL(UNAPIEV.P_EV_REC.DBAPI_NAME, '-')
           AND EV_EVMGR_NAME = NVL(UNAPIEV.P_EV_REC.EVMGR_NAME, '-')
           AND EV_OBJECT_TP  = NVL(UNAPIEV.P_EV_REC.OBJECT_TP, '-')
           AND EV_OBJECT_ID  = NVL(UNAPIEV.P_EV_REC.OBJECT_ID, '-')
           AND NVL(EV_OBJECT_LC, '-')  = NVL(UNAPIEV.P_EV_REC.OBJECT_LC , '-')      
           AND NVL(EV_OBJECT_LC_VERSION, '-') = NVL(UNAPIEV.P_EV_REC.OBJECT_LC_VERSION , '-')
           AND NVL(EV_OBJECT_SS, '-')  = NVL(UNAPIEV.P_EV_REC.OBJECT_SS  , '-')      
           AND EV_EV_TP      = NVL(UNAPIEV.P_EV_REC.EV_TP, '-');
        IF SQL%ROWCOUNT = 0 THEN
           IF UNAPIEV.P_EV_REC.EV_TP LIKE '%StatusChanged' THEN
               UPDATE UTEVSTAT
               SET LC_EV_RULE_EXEC=LC_EV_RULE_EXEC+1
               WHERE EV_CLIENT_ID  = NVL(UNAPIEV.P_EV_REC.CLIENT_ID, '-')
                 AND EV_APPLIC     = NVL(UNAPIEV.P_EV_REC.APPLIC, '-')
                 AND EV_DBAPI_NAME = NVL(UNAPIEV.P_EV_REC.DBAPI_NAME, '-')
                 AND EV_EVMGR_NAME = NVL(UNAPIEV.P_EV_REC.EVMGR_NAME, '-')       
                 AND EV_OBJECT_TP  = NVL(UNAPIEV.P_EV_REC.OBJECT_TP, '-')       
                 AND EV_OBJECT_ID  = NVL(UNAPIEV.P_EV_REC.OBJECT_ID, '-')       
                 AND NVL(EV_OBJECT_LC, '-')  = NVL(UNAPIEV.P_EV_REC.OBJECT_LC , '-')      
                 AND NVL(EV_OBJECT_LC_VERSION, '-') = NVL(UNAPIEV.P_EV_REC.OBJECT_LC_VERSION , '-')
                 AND NVL(EV_OBJECT_SS, '-')  = NVL(UNAPIEV.P_EV_REC.OBJECT_SS  , '-')      
                 AND LC_TRANS > 0;
           ELSE
              BEGIN
                 INSERT INTO UTEVSTAT 
                 (EV_CLIENT_ID, EV_APPLIC, EV_DBAPI_NAME,
                  EV_EVMGR_NAME, EV_OBJECT_TP, EV_OBJECT_ID,
                  EV_OBJECT_LC, EV_OBJECT_LC_VERSION,
                  EV_OBJECT_SS, EV_EV_TP, LC_OBJECT_TP,
                  LC_OBJECT_ID, LC_OBJECT_LC,
                  LC_TRANS, LC_EV_RULE_EXEC)
                 VALUES
                 (NVL(UNAPIEV.P_EV_REC.CLIENT_ID, '-'), NVL(UNAPIEV.P_EV_REC.APPLIC, '-'),
                  NVL(UNAPIEV.P_EV_REC.DBAPI_NAME, '-'), NVL(UNAPIEV.P_EV_REC.EVMGR_NAME, '-'),
                  NVL(UNAPIEV.P_EV_REC.OBJECT_TP, '-'), NVL(UNAPIEV.P_EV_REC.OBJECT_ID, '-'), 
                  NVL(UNAPIEV.P_EV_REC.OBJECT_LC, '-'), NVL(UNAPIEV.P_EV_REC.OBJECT_LC_VERSION, '-'), 
                  NVL(UNAPIEV.P_EV_REC.OBJECT_SS, '-'), NVL(UNAPIEV.P_EV_REC.EV_TP, '-'), 
                  NVL(UNAPIEV.P_EV_REC.OBJECT_TP, '-'), NVL(UNAPIEV.P_EV_REC.OBJECT_ID, '-'),
                  NVL(UNAPIEV.P_EV_REC.OBJECT_LC, '-'), 0, 1);
              EXCEPTION
              WHEN DUP_VAL_ON_INDEX THEN              
                  INSERT INTO UTERROR(CLIENT_ID, APPLIC, WHO, LOGDATE, LOGDATE_TZ, API_NAME, ERROR_MSG)
                  VALUES (UNAPIGEN.P_CLIENT_ID, UNAPIGEN.P_APPLIC_NAME, NVL(UNAPIGEN.P_USER,USER), CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, 'BeginTxn',
                          SUBSTR('rule upd'||
                          UNAPIEV.P_EV_REC.CLIENT_ID||' - '||UNAPIEV.P_EV_REC.APPLIC||' - '||UNAPIEV.P_EV_REC.DBAPI_NAME||' - '||
                          UNAPIEV.P_EV_REC.EVMGR_NAME||' - '|| UNAPIEV.P_EV_REC.OBJECT_TP||' - '|| UNAPIEV.P_EV_REC.OBJECT_ID||' - '|| 
                          UNAPIEV.P_EV_REC.OBJECT_LC||' - '|| UNAPIEV.P_EV_REC.OBJECT_LC_VERSION||' - '|| 
                          UNAPIEV.P_EV_REC.OBJECT_SS||' - '|| UNAPIEV.P_EV_REC.EV_TP||' - '|| 0||' - +1',1,255));
                  UNAPIGEN.U4COMMIT;
              END;





           END IF;
        END IF;
        
















   RETURN(0);
END COLLECTSTAT4EVRULEEXECUTION;

FUNCTION RESETSTAT 
RETURN NUMBER IS
BEGIN
NULL;
END RESETSTAT;

FUNCTION ARCHIVESTAT 
RETURN NUMBER IS
BEGIN
NULL;
END ARCHIVESTAT;


END UNAPIEVSTAT;