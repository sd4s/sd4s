PACKAGE BODY unapirapt AS






STPERROR      EXCEPTION;
L_RET_CODE    INTEGER;
L_SQLERRM     VARCHAR2(255);
L_SQL_STRING  VARCHAR2(2000);
L_DYN_CURSOR  INTEGER;
L_SEP         CHAR(1);

CURSOR L_ALLPTGK_TABLES_CURSOR IS
   SELECT DISTINCT TABLE_NAME,
   LENGTH(TABLE_NAME) TABLE_ORDER2
   FROM USER_TAB_COLUMNS
   WHERE COLUMN_NAME = 'PT'
   AND (TABLE_NAME LIKE 'UTPTGK%')
   ORDER BY 2 ASC, 1 ASC;

FUNCTION GETVERSION
   RETURN VARCHAR2
IS
BEGIN
   RETURN('06.07.00.00_00.13');
EXCEPTION
   WHEN OTHERS THEN
   RETURN (NULL);
END GETVERSION;




PROCEDURE LOGERROR
(A_API IN VARCHAR2, A_ERROR_MSG IN VARCHAR2)
IS
BEGIN
   INSERT INTO UTERROR(CLIENT_ID, APPLIC, WHO, LOGDATE, LOGDATE_TZ, API_NAME, ERROR_MSG)
   VALUES (UNAPIGEN.P_CLIENT_ID, UNAPIGEN.P_APPLIC_NAME, UNAPIGEN.P_USER, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP,
           A_API, A_ERROR_MSG);
END LOGERROR;




FUNCTION REMOVEPTFROMARCHIVE
(A_PT IN VARCHAR2, A_VERSION IN VARCHAR2)
RETURN NUMBER IS
BEGIN
   

   DELETE FROM UAUTPT
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   DELETE FROM UAUTPTAU
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   DELETE FROM UAUTPTHS
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   DELETE FROM UAUTPTHSDETAILS
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   DELETE FROM UAUTPTIP
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   DELETE FROM UAUTPTIPAU
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   DELETE FROM UAUTPTCELLST
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   DELETE FROM UAUTPTCELLSTAU
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   DELETE FROM UAUTPTCELLIP
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   DELETE FROM UAUTPTCELLPP
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   DELETE FROM UAUTPTCS
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   DELETE FROM UAUTPTCSCN
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   DELETE FROM UAUTPTTP
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   L_DYN_CURSOR := DBMS_SQL.OPEN_CURSOR;
   
   FOR L_TABLE_REC IN L_ALLPTGK_TABLES_CURSOR LOOP
      L_SQL_STRING := 'DELETE FROM '||L_TABLE_REC.TABLE_NAME||'@uniarch '||
                      'WHERE pt=:a_pt AND version=:a_version';
      BEGIN
         DBMS_SQL.PARSE(L_DYN_CURSOR, L_SQL_STRING, DBMS_SQL.V7);
         DBMS_SQL.BIND_VARIABLE(L_DYN_CURSOR, ':a_pt', A_PT);
         DBMS_SQL.BIND_VARIABLE(L_DYN_CURSOR, ':a_version', A_VERSION);
         L_RET_CODE := DBMS_SQL.EXECUTE(L_DYN_CURSOR);
      EXCEPTION
      WHEN OTHERS THEN
         IF SQLCODE <> -942 THEN
            L_SQLERRM := SUBSTR(SQLERRM,1,200);
            LOGERROR ('RemovePtFromArchive',L_SQLERRM);
            L_SQLERRM := 'Error while archiving table '||L_TABLE_REC.TABLE_NAME;
            LOGERROR ('RemovePtFromArchive',L_SQLERRM);
         ELSE
            L_SQLERRM := 'Table '||L_TABLE_REC.TABLE_NAME||' does not exist';
            LOGERROR ('RemovePtFromArchive',L_SQLERRM);
         END IF;
      END;
   END LOOP;
   DBMS_SQL.CLOSE_CURSOR(L_DYN_CURSOR);

   RETURN(UNAPIGEN.DBERR_SUCCESS);
END REMOVEPTFROMARCHIVE;




FUNCTION COPYPTTOARCHDB(A_PT IN VARCHAR2, A_VERSION IN VARCHAR2, A_IGNORE_DUP_VAL_ON_INDEX BOOLEAN) RETURN NUMBER IS
BEGIN
   
   EXECUTE IMMEDIATE
   'INSERT INTO uautpt' ||
   UNAPIRA.LISTALLCOLUMNS('utpt', 'BRACKETS', '1') ||
   ' SELECT '||   UNAPIRA.LISTALLCOLUMNS('utpt', 'NO_BRACKETS', '1') ||
   ' FROM utpt' ||
   ' WHERE pt = '''||A_PT||'''' ||
   ' AND version = '''||A_VERSION||'''';
   INSERT INTO UAUTPTAU
      (PT, VERSION, AU, AU_VERSION, AUSEQ, VALUE)
   SELECT        PT, VERSION, AU, AU_VERSION, AUSEQ, VALUE
   FROM UTPTAU
   WHERE PT = A_PT
   AND VERSION = A_VERSION;
   INSERT INTO UAUTPTHS
      (PT, VERSION, WHO, WHO_DESCRIPTION, WHAT, WHAT_DESCRIPTION, LOGDATE,
      LOGDATE_TZ, WHY, TR_SEQ, EV_SEQ)
   SELECT  PT, VERSION, WHO, WHO_DESCRIPTION, WHAT, WHAT_DESCRIPTION, LOGDATE,
      LOGDATE_TZ, WHY, TR_SEQ, EV_SEQ
   FROM UTPTHS
   WHERE PT = A_PT
   AND VERSION = A_VERSION;
   INSERT INTO UAUTPTHSDETAILS
      (PT, VERSION, TR_SEQ, EV_SEQ, SEQ, DETAILS)
   SELECT        PT, VERSION, TR_SEQ, EV_SEQ, SEQ, DETAILS
   FROM UTPTHSDETAILS
   WHERE PT = A_PT
   AND VERSION = A_VERSION;
   INSERT INTO UAUTPTIP
      (PT, VERSION, IP, IP_VERSION, SEQ, IS_PROTECTED, HIDDEN, FREQ_TP, FREQ_VAL,
      FREQ_UNIT, INVERT_FREQ, LAST_SCHED, LAST_SCHED_TZ, LAST_CNT, LAST_VAL,
      INHERIT_AU)
   SELECT  PT, VERSION, IP, IP_VERSION, SEQ, IS_PROTECTED, HIDDEN, FREQ_TP, FREQ_VAL,
      FREQ_UNIT, INVERT_FREQ, LAST_SCHED, LAST_SCHED_TZ, LAST_CNT, LAST_VAL,
      INHERIT_AU
   FROM UTPTIP
   WHERE PT = A_PT
   AND VERSION = A_VERSION;
   INSERT INTO UAUTPTIPAU
      (PT, VERSION, IP, IP_VERSION, AU, AU_VERSION, AUSEQ, VALUE)
   SELECT        PT, VERSION, IP, IP_VERSION, AU, AU_VERSION, AUSEQ, VALUE
   FROM UTPTIPAU
   WHERE PT = A_PT
   AND VERSION = A_VERSION;
   INSERT INTO UAUTPTCELLST
      (PT, VERSION, PTROW, PTCOLUMN, SEQ, ST, ST_VERSION, NR_PLANNED_SC, SC_LC,
      SC_LC_VERSION, SC_UC, SC_UC_VERSION, ADD_STPP, ADD_STIP, NR_SC_MAX,
      INHERIT_AU)
   SELECT  PT, VERSION, PTROW, PTCOLUMN, SEQ, ST, ST_VERSION, NR_PLANNED_SC, SC_LC,
      SC_LC_VERSION, SC_UC, SC_UC_VERSION, ADD_STPP, ADD_STIP, NR_SC_MAX,
      INHERIT_AU
   FROM UTPTCELLST
   WHERE PT = A_PT
   AND VERSION = A_VERSION;
   INSERT INTO UAUTPTCELLSTAU
      (PT, VERSION, PTROW, PTCOLUMN, SEQ, ST, ST_VERSION, AU, AU_VERSION, AUSEQ,
      VALUE)
   SELECT  PT, VERSION, PTROW, PTCOLUMN, SEQ, ST, ST_VERSION, AU, AU_VERSION, AUSEQ,
      VALUE
   FROM UTPTCELLSTAU
   WHERE PT = A_PT
   AND VERSION = A_VERSION;
   INSERT INTO UAUTPTCELLIP
      (PT, VERSION, PTROW, PTCOLUMN, SEQ, IP, IP_VERSION)
   SELECT        PT, VERSION, PTROW, PTCOLUMN, SEQ, IP, IP_VERSION
   FROM UTPTCELLIP
   WHERE PT = A_PT
   AND VERSION = A_VERSION;
   INSERT INTO UAUTPTCELLPP
      (PT, VERSION, PTROW, PTCOLUMN, SEQ, PP, PP_VERSION, PP_KEY1, PP_KEY2, PP_KEY3,
      PP_KEY4, PP_KEY5)
   SELECT  PT, VERSION, PTROW, PTCOLUMN, SEQ, PP, PP_VERSION, PP_KEY1, PP_KEY2, PP_KEY3,
      PP_KEY4, PP_KEY5
   FROM UTPTCELLPP
   WHERE PT = A_PT
   AND VERSION = A_VERSION;
   INSERT INTO UAUTPTCS
      (PT, VERSION, PTROW, CS, DESCRIPTION)
   SELECT        PT, VERSION, PTROW, CS, DESCRIPTION
   FROM UTPTCS
   WHERE PT = A_PT
   AND VERSION = A_VERSION;
   INSERT INTO UAUTPTCSCN
      (PT, VERSION, PTROW, CS, CN, CNSEQ, VALUE)
   SELECT        PT, VERSION, PTROW, CS, CN, CNSEQ, VALUE
   FROM UTPTCSCN
   WHERE PT = A_PT
   AND VERSION = A_VERSION;
   INSERT INTO UAUTPTTP
      (PT, VERSION, PTCOLUMN, TP, TP_UNIT, ALLOW_UPFRONT, ALLOW_UPFRONT_UNIT,
      ALLOW_OVERDUE, ALLOW_OVERDUE_UNIT)
   SELECT  PT, VERSION, PTCOLUMN, TP, TP_UNIT, ALLOW_UPFRONT, ALLOW_UPFRONT_UNIT,
      ALLOW_OVERDUE, ALLOW_OVERDUE_UNIT
   FROM UTPTTP
   WHERE PT = A_PT
   AND VERSION = A_VERSION;
   L_DYN_CURSOR := DBMS_SQL.OPEN_CURSOR;

   
   FOR L_TABLE_REC IN L_ALLPTGK_TABLES_CURSOR LOOP
      L_SQL_STRING := 'INSERT INTO '||L_TABLE_REC.TABLE_NAME||'@uniarch '||
                      UNAPIRA.LISTALLCOLUMNS(L_TABLE_REC.TABLE_NAME, 'BRACKETS', '0') ||
                      ' SELECT '||
                      UNAPIRA.LISTALLCOLUMNS(L_TABLE_REC.TABLE_NAME, 'NO_BRACKETS', '0') ||
                      ' FROM '||L_TABLE_REC.TABLE_NAME||
                      ' WHERE pt=:a_pt'||
                      ' AND version=:a_version';
      BEGIN
         DBMS_SQL.PARSE(L_DYN_CURSOR, L_SQL_STRING, DBMS_SQL.V7);
         DBMS_SQL.BIND_VARIABLE(L_DYN_CURSOR, ':a_pt', A_PT);
         DBMS_SQL.BIND_VARIABLE(L_DYN_CURSOR, ':a_version', A_VERSION);
         L_RET_CODE := DBMS_SQL.EXECUTE(L_DYN_CURSOR);
      EXCEPTION
      WHEN OTHERS THEN
         IF SQLCODE <> -942 THEN
            L_SQLERRM := SUBSTR(SQLERRM,1,200);
            LOGERROR ('CopyPtToArchDB',L_SQLERRM);
            L_SQLERRM := 'Error while archiving table '||L_TABLE_REC.TABLE_NAME;
            LOGERROR ('CopyPtToArchDB',L_SQLERRM);
         ELSE
            L_SQLERRM := 'Table '||L_TABLE_REC.TABLE_NAME||' does not exist';
            LOGERROR ('CopyPtToArchDB',L_SQLERRM);
         END IF;
      END;
   END LOOP;
   DBMS_SQL.CLOSE_CURSOR(L_DYN_CURSOR);

   RETURN(UNAPIGEN.DBERR_SUCCESS);
EXCEPTION
WHEN DUP_VAL_ON_INDEX THEN
   IF A_IGNORE_DUP_VAL_ON_INDEX THEN
      L_RET_CODE := REMOVEPTFROMARCHIVE(A_PT, A_VERSION);
   END IF;
   RETURN(UNAPIGEN.DBERR_NORECORDS);
END COPYPTTOARCHDB;

FUNCTION ARCHIVEPTTODB
(A_PT IN VARCHAR2, A_VERSION IN VARCHAR2)
RETURN NUMBER IS
BEGIN
   L_RET_CODE := COPYPTTOARCHDB(A_PT, A_VERSION, TRUE);
   IF L_RET_CODE = UNAPIGEN.DBERR_NORECORDS THEN
      L_RET_CODE := COPYPTTOARCHDB(A_PT, A_VERSION, FALSE);
      IF L_RET_CODE <> UNAPIGEN.DBERR_SUCCESS THEN
         L_SQLERRM := 'CopyPtToArchDB#return='||TO_CHAR(L_RET_CODE)||' for pt='||A_PT||'#version='||A_VERSION;
         RAISE STPERROR;
      END IF;
   END IF;

   RETURN(UNAPIGEN.DBERR_SUCCESS);
EXCEPTION
WHEN OTHERS THEN
   IF SQLCODE <> 1 THEN
      L_SQLERRM := SUBSTR(SQLERRM,1,200);
   END IF;
   UNAPIGEN.U4ROLLBACK;
   INSERT INTO UTERROR(CLIENT_ID, APPLIC, WHO, LOGDATE, LOGDATE_TZ, API_NAME, ERROR_MSG)
   VALUES(UNAPIGEN.P_CLIENT_ID, UNAPIGEN.P_APPLIC_NAME, UNAPIGEN.P_USER, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP,
          'ArchivePtToDB', L_SQLERRM);
   UNAPIGEN.U4COMMIT;
   RETURN(UNAPIGEN.DBERR_GENFAIL);
END ARCHIVEPTTODB;

FUNCTION COPYPTFROMARCHDB(A_PT IN VARCHAR2, A_VERSION IN VARCHAR2, A_IGNORE_DUP_VAL_ON_INDEX BOOLEAN) RETURN NUMBER IS
BEGIN
   

   EXECUTE IMMEDIATE
   'INSERT INTO utpt' ||
   UNAPIRA.LISTALLCOLUMNS('utpt', 'BRACKETS', '1') ||
   ' SELECT '||   UNAPIRA.LISTALLCOLUMNS('utpt', 'NO_BRACKETS', '1') ||
   ' FROM uautpt' ||
   ' WHERE pt = '''||A_PT||'''' ||
   ' AND version = '''||A_VERSION||'''';

   INSERT INTO UTPTAU
      (PT, VERSION, AU, AU_VERSION, AUSEQ, VALUE)
   SELECT        PT, VERSION, AU, AU_VERSION, AUSEQ, VALUE
   FROM UAUTPTAU
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   INSERT INTO UTPTHS
      (PT, VERSION, WHO, WHO_DESCRIPTION, WHAT, WHAT_DESCRIPTION, LOGDATE,
      LOGDATE_TZ, WHY, TR_SEQ, EV_SEQ)
   SELECT  PT, VERSION, WHO, WHO_DESCRIPTION, WHAT, WHAT_DESCRIPTION, LOGDATE,
      LOGDATE_TZ, WHY, TR_SEQ, EV_SEQ
   FROM UAUTPTHS
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   INSERT INTO UTPTHSDETAILS
      (PT, VERSION, TR_SEQ, EV_SEQ, SEQ, DETAILS)
   SELECT        PT, VERSION, TR_SEQ, EV_SEQ, SEQ, DETAILS
   FROM UAUTPTHSDETAILS
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   INSERT INTO UTPTIP
      (PT, VERSION, IP, IP_VERSION, SEQ, IS_PROTECTED, HIDDEN, FREQ_TP, FREQ_VAL,
      FREQ_UNIT, INVERT_FREQ, LAST_SCHED, LAST_SCHED_TZ, LAST_CNT, LAST_VAL,
      INHERIT_AU)
   SELECT  PT, VERSION, IP, IP_VERSION, SEQ, IS_PROTECTED, HIDDEN, FREQ_TP, FREQ_VAL,
      FREQ_UNIT, INVERT_FREQ, LAST_SCHED, LAST_SCHED_TZ, LAST_CNT, LAST_VAL,
      INHERIT_AU
   FROM UAUTPTIP
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   INSERT INTO UTPTIPAU
      (PT, VERSION, IP, IP_VERSION, AU, AU_VERSION, AUSEQ, VALUE)
   SELECT        PT, VERSION, IP, IP_VERSION, AU, AU_VERSION, AUSEQ, VALUE
   FROM UAUTPTIPAU
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   INSERT INTO UTPTCELLST
      (PT, VERSION, PTROW, PTCOLUMN, SEQ, ST, ST_VERSION, NR_PLANNED_SC, SC_LC,
      SC_LC_VERSION, SC_UC, SC_UC_VERSION, ADD_STPP, ADD_STIP, NR_SC_MAX,
      INHERIT_AU)
   SELECT  PT, VERSION, PTROW, PTCOLUMN, SEQ, ST, ST_VERSION, NR_PLANNED_SC, SC_LC,
      SC_LC_VERSION, SC_UC, SC_UC_VERSION, ADD_STPP, ADD_STIP, NR_SC_MAX,
      INHERIT_AU
   FROM UAUTPTCELLST
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   INSERT INTO UTPTCELLSTAU
      (PT, VERSION, PTROW, PTCOLUMN, SEQ, ST, ST_VERSION, AU, AU_VERSION, AUSEQ,
      VALUE)
   SELECT  PT, VERSION, PTROW, PTCOLUMN, SEQ, ST, ST_VERSION, AU, AU_VERSION, AUSEQ,
      VALUE
   FROM UAUTPTCELLSTAU
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   INSERT INTO UTPTCELLIP
      (PT, VERSION, PTROW, PTCOLUMN, SEQ, IP, IP_VERSION)
   SELECT        PT, VERSION, PTROW, PTCOLUMN, SEQ, IP, IP_VERSION
   FROM UAUTPTCELLIP
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   INSERT INTO UTPTCELLPP
      (PT, VERSION, PTROW, PTCOLUMN, SEQ, PP, PP_VERSION, PP_KEY1, PP_KEY2, PP_KEY3,
      PP_KEY4, PP_KEY5)
   SELECT  PT, VERSION, PTROW, PTCOLUMN, SEQ, PP, PP_VERSION, PP_KEY1, PP_KEY2, PP_KEY3,
      PP_KEY4, PP_KEY5
   FROM UAUTPTCELLPP
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   INSERT INTO UTPTCS
      (PT, VERSION, PTROW, CS, DESCRIPTION)
   SELECT        PT, VERSION, PTROW, CS, DESCRIPTION
   FROM UAUTPTCS
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   INSERT INTO UTPTCSCN
      (PT, VERSION, PTROW, CS, CN, CNSEQ, VALUE)
   SELECT        PT, VERSION, PTROW, CS, CN, CNSEQ, VALUE
   FROM UAUTPTCSCN
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   INSERT INTO UTPTTP
      (PT, VERSION, PTCOLUMN, TP, TP_UNIT, ALLOW_UPFRONT, ALLOW_UPFRONT_UNIT,
      ALLOW_OVERDUE, ALLOW_OVERDUE_UNIT)
   SELECT  PT, VERSION, PTCOLUMN, TP, TP_UNIT, ALLOW_UPFRONT, ALLOW_UPFRONT_UNIT,
      ALLOW_OVERDUE, ALLOW_OVERDUE_UNIT
   FROM UAUTPTTP
   WHERE PT = A_PT
   AND VERSION = A_VERSION;
   L_DYN_CURSOR := DBMS_SQL.OPEN_CURSOR;
   
   FOR L_TABLE_REC IN L_ALLPTGK_TABLES_CURSOR LOOP
      L_SQL_STRING := 'INSERT INTO '||L_TABLE_REC.TABLE_NAME||' '||
                      UNAPIRA.LISTALLCOLUMNS(L_TABLE_REC.TABLE_NAME, 'BRACKETS', '0') ||
                      ' SELECT '||
                      UNAPIRA.LISTALLCOLUMNS(L_TABLE_REC.TABLE_NAME, 'NO_BRACKETS', '0') ||
                      ' FROM '||L_TABLE_REC.TABLE_NAME||'@uniarch '||
                      ' WHERE pt=:a_pt'||
                      ' AND version=:a_version';
      BEGIN
         DBMS_SQL.PARSE(L_DYN_CURSOR, L_SQL_STRING, DBMS_SQL.V7);
         DBMS_SQL.BIND_VARIABLE(L_DYN_CURSOR, ':a_pt', A_PT);
         DBMS_SQL.BIND_VARIABLE(L_DYN_CURSOR, ':a_version', A_VERSION);
         L_RET_CODE := DBMS_SQL.EXECUTE(L_DYN_CURSOR);
      EXCEPTION
      WHEN OTHERS THEN
         IF SQLCODE <> -942 THEN
            L_SQLERRM := SUBSTR(SQLERRM,1,200);
            LOGERROR ('CopyPtFromArchDB',L_SQLERRM);
            L_SQLERRM := 'Error while archiving table '||L_TABLE_REC.TABLE_NAME;
            LOGERROR ('CopyPtFromArchDB',L_SQLERRM);
         ELSE
            L_SQLERRM := 'Table '||L_TABLE_REC.TABLE_NAME||' does not exist';
            LOGERROR ('CopyPtFromArchDB',L_SQLERRM);
         END IF;
      END;
   END LOOP;
   DBMS_SQL.CLOSE_CURSOR(L_DYN_CURSOR);

   RETURN(UNAPIGEN.DBERR_SUCCESS);
EXCEPTION
WHEN DUP_VAL_ON_INDEX THEN
   IF A_IGNORE_DUP_VAL_ON_INDEX THEN
      L_RET_CODE := REMOVEPTFROMDB(A_PT, A_VERSION);
   END IF;
   RETURN(UNAPIGEN.DBERR_NORECORDS);
END COPYPTFROMARCHDB;

FUNCTION RESTOREPTFROMDB
(A_PT IN VARCHAR2, A_VERSION IN VARCHAR2)
RETURN NUMBER IS
BEGIN
   L_RET_CODE := COPYPTFROMARCHDB(A_PT, A_VERSION, TRUE);
   IF L_RET_CODE = UNAPIGEN.DBERR_NORECORDS THEN
      L_RET_CODE := COPYPTFROMARCHDB(A_PT, A_VERSION, FALSE);
      IF L_RET_CODE <> UNAPIGEN.DBERR_SUCCESS THEN
         L_SQLERRM := 'CopyPtFromArchDB#return='||TO_CHAR(L_RET_CODE)||' for pt='||A_PT||'#version='||A_VERSION;
         RAISE STPERROR;
      END IF;
   END IF;

   RETURN(UNAPIGEN.DBERR_SUCCESS);
EXCEPTION
WHEN OTHERS THEN
   IF SQLCODE <> 1 THEN
      L_SQLERRM := SUBSTR(SQLERRM,1,200);
   END IF;
   UNAPIGEN.U4ROLLBACK;
   INSERT INTO UTERROR(CLIENT_ID, APPLIC, WHO, LOGDATE, LOGDATE_TZ, API_NAME, ERROR_MSG)
   VALUES(UNAPIGEN.P_CLIENT_ID, UNAPIGEN.P_APPLIC_NAME, UNAPIGEN.P_USER, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP,
          'RestorePtFromDB', L_SQLERRM);
   UNAPIGEN.U4COMMIT;
   RETURN(UNAPIGEN.DBERR_GENFAIL);
END RESTOREPTFROMDB;

FUNCTION REMOVEPTFROMDB
(A_PT IN VARCHAR2, A_VERSION IN VARCHAR2)
RETURN NUMBER IS
BEGIN
   

   DELETE FROM UTPT
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   DELETE FROM UTPTAU
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   DELETE FROM UTPTHS
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   DELETE FROM UTPTHSDETAILS
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   DELETE FROM UTPTIP
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   DELETE FROM UTPTIPAU
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   DELETE FROM UTPTCELLST
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   DELETE FROM UTPTCELLSTAU
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   DELETE FROM UTPTCELLIP
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   DELETE FROM UTPTCELLPP
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   DELETE FROM UTPTCS
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   DELETE FROM UTPTCSCN
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   DELETE FROM UTPTTP
   WHERE PT = A_PT
   AND VERSION = A_VERSION;

   L_DYN_CURSOR := DBMS_SQL.OPEN_CURSOR;
   
   FOR L_TABLE_REC IN L_ALLPTGK_TABLES_CURSOR LOOP
      L_SQL_STRING := 'DELETE FROM '||L_TABLE_REC.TABLE_NAME ||
                      ' WHERE pt=:a_pt'||
                      ' AND version=:a_version';
      BEGIN
         DBMS_SQL.PARSE(L_DYN_CURSOR, L_SQL_STRING, DBMS_SQL.V7);
         DBMS_SQL.BIND_VARIABLE(L_DYN_CURSOR, ':a_pt', A_PT);
         DBMS_SQL.BIND_VARIABLE(L_DYN_CURSOR, ':a_version', A_VERSION);
         L_RET_CODE := DBMS_SQL.EXECUTE(L_DYN_CURSOR);
      EXCEPTION
      WHEN OTHERS THEN
         IF SQLCODE <> -942 THEN
            L_SQLERRM := SUBSTR(SQLERRM,1,200);
            LOGERROR ('RemovePtFromDB',L_SQLERRM);
            L_SQLERRM := 'Error while archiving table '||L_TABLE_REC.TABLE_NAME;
            LOGERROR ('RemovePtFromDB',L_SQLERRM);
         ELSE
            L_SQLERRM := 'Table '||L_TABLE_REC.TABLE_NAME||' does not exist';
            LOGERROR ('RemovePtFromDB',L_SQLERRM);
         END IF;
      END;
   END LOOP;
   DBMS_SQL.CLOSE_CURSOR(L_DYN_CURSOR);

   RETURN(UNAPIGEN.DBERR_SUCCESS);
END REMOVEPTFROMDB;

FUNCTION ARCHIVEPTTOFILE
(A_PT IN VARCHAR2, A_VERSION IN VARCHAR2)
RETURN NUMBER IS

CURSOR L_UTPT_CURSOR (A_PT IN VARCHAR2, A_VERSION IN VARCHAR2) IS
   SELECT * FROM UDPT WHERE PT=A_PT AND VERSION=A_VERSION;

CURSOR L_UTPTAU_CURSOR (A_PT IN VARCHAR2, A_VERSION IN VARCHAR2) IS
   SELECT * FROM UTPTAU WHERE PT=A_PT AND VERSION=A_VERSION;

CURSOR L_UTPTHS_CURSOR (A_PT IN VARCHAR2, A_VERSION IN VARCHAR2) IS
   SELECT * FROM UTPTHS WHERE PT=A_PT AND VERSION=A_VERSION;

CURSOR L_UTPTHSDETAILS_CURSOR (A_PT IN VARCHAR2, A_VERSION IN VARCHAR2) IS
   SELECT * FROM UTPTHSDETAILS WHERE PT=A_PT AND VERSION=A_VERSION;

CURSOR L_UTPTIP_CURSOR (A_PT IN VARCHAR2, A_VERSION IN VARCHAR2) IS
   SELECT * FROM UTPTIP WHERE PT=A_PT AND VERSION=A_VERSION;

CURSOR L_UTPTIPAU_CURSOR (A_PT IN VARCHAR2, A_VERSION IN VARCHAR2) IS
   SELECT * FROM UTPTIPAU WHERE PT=A_PT AND VERSION=A_VERSION;

CURSOR L_UTPTCELLST_CURSOR (A_PT IN VARCHAR2, A_VERSION IN VARCHAR2) IS
   SELECT * FROM UTPTCELLST WHERE PT=A_PT AND VERSION=A_VERSION;

CURSOR L_UTPTCELLSTAU_CURSOR (A_PT IN VARCHAR2, A_VERSION IN VARCHAR2) IS
   SELECT * FROM UTPTCELLSTAU WHERE PT=A_PT AND VERSION=A_VERSION;

CURSOR L_UTPTCELLIP_CURSOR (A_PT IN VARCHAR2, A_VERSION IN VARCHAR2) IS
   SELECT * FROM UTPTCELLIP WHERE PT=A_PT AND VERSION=A_VERSION;

CURSOR L_UTPTCELLPP_CURSOR (A_PT IN VARCHAR2, A_VERSION IN VARCHAR2) IS
   SELECT * FROM UTPTCELLPP WHERE PT=A_PT AND VERSION=A_VERSION;

CURSOR L_UTPTCS_CURSOR (A_PT IN VARCHAR2, A_VERSION IN VARCHAR2) IS
   SELECT * FROM UTPTCS WHERE PT=A_PT AND VERSION=A_VERSION;

CURSOR L_UTPTCSCN_CURSOR (A_PT IN VARCHAR2, A_VERSION IN VARCHAR2) IS
   SELECT * FROM UTPTCSCN WHERE PT=A_PT AND VERSION=A_VERSION;

CURSOR L_UTPTTP_CURSOR (A_PT IN VARCHAR2, A_VERSION IN VARCHAR2) IS
   SELECT * FROM UTPTTP WHERE PT=A_PT AND VERSION=A_VERSION;

BEGIN
   L_SQLERRM:=NULL;
   UNAPIRA.L_EXCEPTION_STEP :='utpt' ||'pt='||A_PT||'#version='||A_VERSION;
   FOR L_REC IN L_UTPT_CURSOR(A_PT, A_VERSION) LOOP
      UNAPIRA3.L_PUTTEXT := 'utpt' || L_SEP ||
      L_REC.PT || L_SEP || L_REC.VERSION || L_SEP ||
      TO_CHAR(L_REC.EFFECTIVE_FROM,UNAPIRA.P_TSTZ_FORMAT) || L_SEP ||
      TO_CHAR(L_REC.EFFECTIVE_FROM_TZ,UNAPIRA.P_TSTZ_FORMAT) || L_SEP ||
      TO_CHAR(L_REC.EFFECTIVE_TILL,UNAPIRA.P_TSTZ_FORMAT) || L_SEP ||
      TO_CHAR(L_REC.EFFECTIVE_TILL_TZ,UNAPIRA.P_TSTZ_FORMAT) || L_SEP ||
      L_REC.DESCRIPTION || L_SEP || L_REC.DESCRIPTION2 || L_SEP ||
      L_REC.DESCR_DOC || L_SEP || L_REC.DESCR_DOC_VERSION || L_SEP ||
      L_REC.IS_TEMPLATE || L_SEP || L_REC.CONFIRM_USERID || L_SEP ||
      L_REC.NR_PLANNED_SD || L_SEP || L_REC.FREQ_TP || L_SEP ||
      L_REC.FREQ_VAL || L_SEP || L_REC.FREQ_UNIT || L_SEP ||
      L_REC.INVERT_FREQ || L_SEP ||
      TO_CHAR(L_REC.LAST_SCHED,UNAPIRA.P_TSTZ_FORMAT) || L_SEP ||
      TO_CHAR(L_REC.LAST_SCHED_TZ,UNAPIRA.P_TSTZ_FORMAT) || L_SEP ||
      L_REC.LAST_CNT || L_SEP || L_REC.LAST_VAL || L_SEP ||
      L_REC.LABEL_FORMAT || L_SEP || L_REC.PLANNED_RESPONSIBLE || L_SEP ||
      L_REC.SD_UC || L_SEP || L_REC.SD_UC_VERSION || L_SEP ||
      L_REC.SD_LC || L_SEP || L_REC.SD_LC_VERSION || L_SEP ||
      L_REC.INHERIT_AU || L_SEP || L_REC.INHERIT_GK || L_SEP ||
      L_REC.LAST_COMMENT || L_SEP || L_REC.PT_CLASS || L_SEP ||
      L_REC.LOG_HS || L_SEP || L_REC.LOG_HS_DETAILS || L_SEP ||
      L_REC.ALLOW_MODIFY || L_SEP || L_REC.ACTIVE || L_SEP || L_REC.LC || L_SEP ||
      L_REC.LC_VERSION || L_SEP || L_REC.SS || L_SEP || L_REC.AR1 || L_SEP ||
      L_REC.AR2 || L_SEP || L_REC.AR3 || L_SEP || L_REC.AR4 || L_SEP ||
      L_REC.AR5 || L_SEP || L_REC.AR6 || L_SEP || L_REC.AR7 || L_SEP ||
      L_REC.AR8 || L_SEP || L_REC.AR9 || L_SEP || L_REC.AR10 || L_SEP ||
      L_REC.AR11 || L_SEP || L_REC.AR12 || L_SEP || L_REC.AR13 || L_SEP ||
      L_REC.AR14 || L_SEP || L_REC.AR15 || L_SEP || L_REC.AR16 || L_SEP ||
      L_REC.AR17 || L_SEP || L_REC.AR18 || L_SEP || L_REC.AR19 || L_SEP ||
      L_REC.AR20 || L_SEP || L_REC.AR21 || L_SEP || L_REC.AR22 || L_SEP ||
      L_REC.AR23 || L_SEP || L_REC.AR24 || L_SEP || L_REC.AR25 || L_SEP ||
      L_REC.AR26 || L_SEP || L_REC.AR27 || L_SEP || L_REC.AR28 || L_SEP ||
      L_REC.AR29 || L_SEP || L_REC.AR30 || L_SEP || L_REC.AR31 || L_SEP ||
      L_REC.AR32 || L_SEP || L_REC.AR33 || L_SEP || L_REC.AR34 || L_SEP ||
      L_REC.AR35 || L_SEP || L_REC.AR36 || L_SEP || L_REC.AR37 || L_SEP ||
      L_REC.AR38 || L_SEP || L_REC.AR39 || L_SEP || L_REC.AR40 || L_SEP ||
      L_REC.AR41 || L_SEP || L_REC.AR42 || L_SEP || L_REC.AR43 || L_SEP ||
      L_REC.AR44 || L_SEP || L_REC.AR45 || L_SEP || L_REC.AR46 || L_SEP ||
      L_REC.AR47 || L_SEP || L_REC.AR48 || L_SEP || L_REC.AR49 || L_SEP ||
      L_REC.AR50 || L_SEP || L_REC.AR51 || L_SEP || L_REC.AR52 || L_SEP ||
      L_REC.AR53 || L_SEP || L_REC.AR54 || L_SEP || L_REC.AR55 || L_SEP ||
      L_REC.AR56 || L_SEP || L_REC.AR57 || L_SEP || L_REC.AR58 || L_SEP ||
      L_REC.AR59 || L_SEP || L_REC.AR60 || L_SEP || L_REC.AR61 || L_SEP ||
      L_REC.AR62 || L_SEP || L_REC.AR63 || L_SEP || L_REC.AR64 || L_SEP ||
      L_REC.AR65 || L_SEP || L_REC.AR66 || L_SEP || L_REC.AR67 || L_SEP ||
      L_REC.AR68 || L_SEP || L_REC.AR69 || L_SEP || L_REC.AR70 || L_SEP ||
      L_REC.AR71 || L_SEP || L_REC.AR72 || L_SEP || L_REC.AR73 || L_SEP ||
      L_REC.AR74 || L_SEP || L_REC.AR75 || L_SEP || L_REC.AR76 || L_SEP ||
      L_REC.AR77 || L_SEP || L_REC.AR78 || L_SEP || L_REC.AR79 || L_SEP ||
      L_REC.AR80 || L_SEP || L_REC.AR81 || L_SEP || L_REC.AR82 || L_SEP ||
      L_REC.AR83 || L_SEP || L_REC.AR84 || L_SEP || L_REC.AR85 || L_SEP ||
      L_REC.AR86 || L_SEP || L_REC.AR87 || L_SEP || L_REC.AR88 || L_SEP ||
      L_REC.AR89 || L_SEP || L_REC.AR90 || L_SEP || L_REC.AR91 || L_SEP ||
      L_REC.AR92 || L_SEP || L_REC.AR93 || L_SEP || L_REC.AR94 || L_SEP ||
      L_REC.AR95 || L_SEP || L_REC.AR96 || L_SEP || L_REC.AR97 || L_SEP ||
      L_REC.AR98 || L_SEP || L_REC.AR99 || L_SEP || L_REC.AR100 || L_SEP ||
      L_REC.AR101 || L_SEP || L_REC.AR102 || L_SEP || L_REC.AR103 || L_SEP ||
      L_REC.AR104 || L_SEP || L_REC.AR105 || L_SEP || L_REC.AR106 || L_SEP ||
      L_REC.AR107 || L_SEP || L_REC.AR108 || L_SEP || L_REC.AR109 || L_SEP ||
      L_REC.AR110 || L_SEP || L_REC.AR111 || L_SEP || L_REC.AR112 || L_SEP ||
      L_REC.AR113 || L_SEP || L_REC.AR114 || L_SEP || L_REC.AR115 || L_SEP ||
      L_REC.AR116 || L_SEP || L_REC.AR117 || L_SEP || L_REC.AR118 || L_SEP ||
      L_REC.AR119 || L_SEP || L_REC.AR120 || L_SEP || L_REC.AR121 || L_SEP ||
      L_REC.AR122 || L_SEP || L_REC.AR123 || L_SEP || L_REC.AR124 || L_SEP ||
      L_REC.AR125 || L_SEP || L_REC.AR126 || L_SEP || L_REC.AR127 || L_SEP ||
      L_REC.AR128;
      UNAPIRA3.U4DATAPUTLINE(UNAPIRA3.L_PUTTEXT);
   END LOOP;

   UNAPIRA.L_EXCEPTION_STEP :='utptau' ||'pt='||A_PT||'#version='||A_VERSION;
   FOR L_REC IN L_UTPTAU_CURSOR(A_PT, A_VERSION) LOOP
      UNAPIRA3.L_PUTTEXT := 'utptau' || L_SEP ||
      L_REC.PT || L_SEP || L_REC.VERSION || L_SEP || L_REC.AU || L_SEP ||
      L_REC.AU_VERSION || L_SEP || L_REC.AUSEQ || L_SEP || L_REC.VALUE;
      UNAPIRA3.U4DATAPUTLINE(UNAPIRA3.L_PUTTEXT);
   END LOOP;

   UNAPIRA.L_EXCEPTION_STEP :='utpths' ||'pt='||A_PT||'#version='||A_VERSION;
   FOR L_REC IN L_UTPTHS_CURSOR(A_PT, A_VERSION) LOOP
      UNAPIRA3.L_PUTTEXT := 'utpths' || L_SEP ||
      L_REC.PT || L_SEP || L_REC.VERSION || L_SEP || L_REC.WHO || L_SEP ||
      L_REC.WHO_DESCRIPTION || L_SEP || L_REC.WHAT || L_SEP ||
      L_REC.WHAT_DESCRIPTION || L_SEP ||
      TO_CHAR(L_REC.LOGDATE,UNAPIRA.P_TSTZ_FORMAT) || L_SEP ||
      TO_CHAR(L_REC.LOGDATE_TZ,UNAPIRA.P_TSTZ_FORMAT) || L_SEP ||
      L_REC.WHY || L_SEP || L_REC.TR_SEQ || L_SEP || L_REC.EV_SEQ;
      UNAPIRA3.U4DATAPUTLINE(UNAPIRA3.L_PUTTEXT);
   END LOOP;

   UNAPIRA.L_EXCEPTION_STEP :='utpthsdetails' ||'pt='||A_PT||'#version='||A_VERSION;
   FOR L_REC IN L_UTPTHSDETAILS_CURSOR(A_PT, A_VERSION) LOOP
      UNAPIRA3.L_PUTTEXT := 'utpthsdetails' || L_SEP ||
      L_REC.PT || L_SEP || L_REC.VERSION || L_SEP || L_REC.TR_SEQ || L_SEP ||
      L_REC.EV_SEQ || L_SEP || L_REC.SEQ || L_SEP || L_REC.DETAILS;
      UNAPIRA3.U4DATAPUTLINE(UNAPIRA3.L_PUTTEXT);
   END LOOP;

   UNAPIRA.L_EXCEPTION_STEP :='utptip' ||'pt='||A_PT||'#version='||A_VERSION;
   FOR L_REC IN L_UTPTIP_CURSOR(A_PT, A_VERSION) LOOP
      UNAPIRA3.L_PUTTEXT := 'utptip' || L_SEP ||
      L_REC.PT || L_SEP || L_REC.VERSION || L_SEP || L_REC.IP || L_SEP ||
      L_REC.IP_VERSION || L_SEP || L_REC.SEQ || L_SEP ||
      L_REC.IS_PROTECTED || L_SEP || L_REC.HIDDEN || L_SEP ||
      L_REC.FREQ_TP || L_SEP || L_REC.FREQ_VAL || L_SEP ||
      L_REC.FREQ_UNIT || L_SEP || L_REC.INVERT_FREQ || L_SEP ||
      TO_CHAR(L_REC.LAST_SCHED,UNAPIRA.P_TSTZ_FORMAT) || L_SEP ||
      TO_CHAR(L_REC.LAST_SCHED_TZ,UNAPIRA.P_TSTZ_FORMAT) || L_SEP ||
      L_REC.LAST_CNT || L_SEP || L_REC.LAST_VAL || L_SEP ||
      L_REC.INHERIT_AU;
      UNAPIRA3.U4DATAPUTLINE(UNAPIRA3.L_PUTTEXT);
   END LOOP;

   UNAPIRA.L_EXCEPTION_STEP :='utptipau' ||'pt='||A_PT||'#version='||A_VERSION;
   FOR L_REC IN L_UTPTIPAU_CURSOR(A_PT, A_VERSION) LOOP
      UNAPIRA3.L_PUTTEXT := 'utptipau' || L_SEP ||
      L_REC.PT || L_SEP || L_REC.VERSION || L_SEP || L_REC.IP || L_SEP ||
      L_REC.IP_VERSION || L_SEP || L_REC.AU || L_SEP ||
      L_REC.AU_VERSION || L_SEP || L_REC.AUSEQ || L_SEP || L_REC.VALUE;
      UNAPIRA3.U4DATAPUTLINE(UNAPIRA3.L_PUTTEXT);
   END LOOP;

   UNAPIRA.L_EXCEPTION_STEP :='utptcellst' ||'pt='||A_PT||'#version='||A_VERSION;
   FOR L_REC IN L_UTPTCELLST_CURSOR(A_PT, A_VERSION) LOOP
      UNAPIRA3.L_PUTTEXT := 'utptcellst' || L_SEP ||
      L_REC.PT || L_SEP || L_REC.VERSION || L_SEP || L_REC.PTROW || L_SEP ||
      L_REC.PTCOLUMN || L_SEP || L_REC.SEQ || L_SEP || L_REC.ST || L_SEP ||
      L_REC.ST_VERSION || L_SEP || L_REC.NR_PLANNED_SC || L_SEP ||
      L_REC.SC_LC || L_SEP || L_REC.SC_LC_VERSION || L_SEP ||
      L_REC.SC_UC || L_SEP || L_REC.SC_UC_VERSION || L_SEP ||
      L_REC.ADD_STPP || L_SEP || L_REC.ADD_STIP || L_SEP ||
      L_REC.NR_SC_MAX || L_SEP || L_REC.INHERIT_AU;
      UNAPIRA3.U4DATAPUTLINE(UNAPIRA3.L_PUTTEXT);
   END LOOP;

   UNAPIRA.L_EXCEPTION_STEP :='utptcellstau' ||'pt='||A_PT||'#version='||A_VERSION;
   FOR L_REC IN L_UTPTCELLSTAU_CURSOR(A_PT, A_VERSION) LOOP
      UNAPIRA3.L_PUTTEXT := 'utptcellstau' || L_SEP ||
      L_REC.PT || L_SEP || L_REC.VERSION || L_SEP || L_REC.PTROW || L_SEP ||
      L_REC.PTCOLUMN || L_SEP || L_REC.SEQ || L_SEP || L_REC.ST || L_SEP ||
      L_REC.ST_VERSION || L_SEP || L_REC.AU || L_SEP ||
      L_REC.AU_VERSION || L_SEP || L_REC.AUSEQ || L_SEP || L_REC.VALUE;
      UNAPIRA3.U4DATAPUTLINE(UNAPIRA3.L_PUTTEXT);
   END LOOP;

   UNAPIRA.L_EXCEPTION_STEP :='utptcellip' ||'pt='||A_PT||'#version='||A_VERSION;
   FOR L_REC IN L_UTPTCELLIP_CURSOR(A_PT, A_VERSION) LOOP
      UNAPIRA3.L_PUTTEXT := 'utptcellip' || L_SEP ||
      L_REC.PT || L_SEP || L_REC.VERSION || L_SEP || L_REC.PTROW || L_SEP ||
      L_REC.PTCOLUMN || L_SEP || L_REC.SEQ || L_SEP || L_REC.IP || L_SEP ||
      L_REC.IP_VERSION;
      UNAPIRA3.U4DATAPUTLINE(UNAPIRA3.L_PUTTEXT);
   END LOOP;

   UNAPIRA.L_EXCEPTION_STEP :='utptcellpp' ||'pt='||A_PT||'#version='||A_VERSION;
   FOR L_REC IN L_UTPTCELLPP_CURSOR(A_PT, A_VERSION) LOOP
      UNAPIRA3.L_PUTTEXT := 'utptcellpp' || L_SEP ||
      L_REC.PT || L_SEP || L_REC.VERSION || L_SEP || L_REC.PTROW || L_SEP ||
      L_REC.PTCOLUMN || L_SEP || L_REC.SEQ || L_SEP || L_REC.PP || L_SEP ||
      L_REC.PP_VERSION || L_SEP || L_REC.PP_KEY1 || L_SEP ||
      L_REC.PP_KEY2 || L_SEP || L_REC.PP_KEY3 || L_SEP ||
      L_REC.PP_KEY4 || L_SEP || L_REC.PP_KEY5;
      UNAPIRA3.U4DATAPUTLINE(UNAPIRA3.L_PUTTEXT);
   END LOOP;

   UNAPIRA.L_EXCEPTION_STEP :='utptcs' ||'pt='||A_PT||'#version='||A_VERSION;
   FOR L_REC IN L_UTPTCS_CURSOR(A_PT, A_VERSION) LOOP
      UNAPIRA3.L_PUTTEXT := 'utptcs' || L_SEP ||
      L_REC.PT || L_SEP || L_REC.VERSION || L_SEP || L_REC.PTROW || L_SEP ||
      L_REC.CS || L_SEP || L_REC.DESCRIPTION;
      UNAPIRA3.U4DATAPUTLINE(UNAPIRA3.L_PUTTEXT);
   END LOOP;

   UNAPIRA.L_EXCEPTION_STEP :='utptcscn' ||'pt='||A_PT||'#version='||A_VERSION;
   FOR L_REC IN L_UTPTCSCN_CURSOR(A_PT, A_VERSION) LOOP
      UNAPIRA3.L_PUTTEXT := 'utptcscn' || L_SEP ||
      L_REC.PT || L_SEP || L_REC.VERSION || L_SEP || L_REC.PTROW || L_SEP ||
      L_REC.CS || L_SEP || L_REC.CN || L_SEP || L_REC.CNSEQ || L_SEP ||
      L_REC.VALUE;
      UNAPIRA3.U4DATAPUTLINE(UNAPIRA3.L_PUTTEXT);
   END LOOP;

   UNAPIRA.L_EXCEPTION_STEP :='utpttp' ||'pt='||A_PT||'#version='||A_VERSION;
   FOR L_REC IN L_UTPTTP_CURSOR(A_PT, A_VERSION) LOOP
      UNAPIRA3.L_PUTTEXT := 'utpttp' || L_SEP ||
      L_REC.PT || L_SEP || L_REC.VERSION || L_SEP || L_REC.PTCOLUMN || L_SEP ||
      L_REC.TP || L_SEP || L_REC.TP_UNIT || L_SEP ||
      L_REC.ALLOW_UPFRONT || L_SEP || L_REC.ALLOW_UPFRONT_UNIT || L_SEP ||
      L_REC.ALLOW_OVERDUE || L_SEP || L_REC.ALLOW_OVERDUE_UNIT;
      UNAPIRA3.U4DATAPUTLINE(UNAPIRA3.L_PUTTEXT);
   END LOOP;

   
   
   UNAPIRA.L_EXCEPTION_STEP :='ArchivePtGkToFile#st='||A_PT||'#version='||A_VERSION;
   L_RET_CODE := UNAPIRA3.ARCHIVEPTGKTOFILE(A_PT, A_VERSION);
   IF L_RET_CODE <> UNAPIGEN.DBERR_SUCCESS THEN
      L_SQLERRM := 'ArchivePtGkToFile return='||L_RET_CODE||'for pt '||A_PT||'#version='||A_VERSION;
      RAISE STPERROR;
   END IF;

   UNAPIRA3.U4DATAPUTLINE( ' ');

   RETURN(UNAPIGEN.DBERR_SUCCESS);
EXCEPTION
WHEN UTL_FILE.INVALID_PATH THEN
   L_SQLERRM := 'directory='||UNAPIRA.P_FILE_DIR||'#file='||UNAPIRA.P_FILE_NAME ||':Invalid path';
   UNAPIRA.UTLFILEEXCEPTIONHANDLER('ArchivePtToFile', L_SQLERRM, 'UTL_FILE.INVALID_PATH',UNAPIRA.P_CLOSE_CURSOR);
   RETURN(UNAPIGEN.DBERR_NOOBJECT);

WHEN UTL_FILE.INVALID_MODE THEN
   L_SQLERRM := 'directory='||UNAPIRA.P_FILE_DIR||'#file='||UNAPIRA.P_FILE_NAME ||':Invalid mode';
   UNAPIRA.UTLFILEEXCEPTIONHANDLER('ArchivePtToFile', L_SQLERRM, 'UTL_FILE.INVALID_MODE',UNAPIRA.P_CLOSE_CURSOR);
   RETURN(UNAPIGEN.DBERR_GENFAIL);

WHEN UTL_FILE.INVALID_FILEHANDLE THEN
   L_SQLERRM := 'directory='||UNAPIRA.P_FILE_DIR||'#file='||UNAPIRA.P_FILE_NAME ||':Invalid filehandle';
   UNAPIRA.UTLFILEEXCEPTIONHANDLER('ArchivePtToFile', L_SQLERRM, 'UTL_FILE.INVALID_FILEHANDLE',UNAPIRA.P_CLOSE_CURSOR);
   RETURN(UNAPIGEN.DBERR_GENFAIL);

WHEN UTL_FILE.INVALID_OPERATION THEN
   
   L_SQLERRM := 'directory='||UNAPIRA.P_FILE_DIR||'#file='||UNAPIRA.P_FILE_NAME ||':Invalid operation';
   UNAPIRA.UTLFILEEXCEPTIONHANDLER('ArchivePtToFile', L_SQLERRM, 'UTL_FILE.INVALID_OPERATION',UNAPIRA.P_CLOSE_CURSOR);
   RETURN(UNAPIGEN.DBERR_NOOBJECT);

WHEN UTL_FILE.READ_ERROR THEN
   L_SQLERRM := 'directory='||UNAPIRA.P_FILE_DIR||'#file='||UNAPIRA.P_FILE_NAME ||':Read error';
   UNAPIRA.UTLFILEEXCEPTIONHANDLER('ArchivePtToFile', L_SQLERRM, 'UTL_FILE.READ_ERROR',UNAPIRA.P_CLOSE_CURSOR);
   RETURN(UNAPIGEN.DBERR_GENFAIL);

WHEN UTL_FILE.WRITE_ERROR THEN
   L_SQLERRM := 'directory='||UNAPIRA.P_FILE_DIR||'#file='||UNAPIRA.P_FILE_NAME ||':Write error';
   UNAPIRA.UTLFILEEXCEPTIONHANDLER('ArchivePtToFile', L_SQLERRM, 'UTL_FILE.WRITE_ERROR',UNAPIRA.P_CLOSE_CURSOR);
   RETURN(UNAPIGEN.DBERR_GENFAIL);

WHEN UTL_FILE.INTERNAL_ERROR THEN
   L_SQLERRM := 'directory='||UNAPIRA.P_FILE_DIR||'#file='||UNAPIRA.P_FILE_NAME ||':Internal error';
   UNAPIRA.UTLFILEEXCEPTIONHANDLER('ArchivePtToFile', L_SQLERRM, 'UTL_FILE.INTERNAL_ERROR',UNAPIRA.P_CLOSE_CURSOR);
   RETURN(UNAPIGEN.DBERR_GENFAIL);

WHEN OTHERS THEN
   IF SQLCODE <> 1 THEN
      L_SQLERRM := SQLERRM;
      UNAPIRA.UTLFILEEXCEPTIONHANDLER('ArchivePtToFile', L_SQLERRM, 'UTL_FILE.INTERNAL_ERROR',UNAPIRA.P_CLOSE_CURSOR);
   ELSIF L_SQLERRM IS NOT NULL THEN
      UNAPIRA.UTLFILEEXCEPTIONHANDLER('ArchivePtToFile', L_SQLERRM, 'UTL_FILE.INTERNAL_ERROR',UNAPIRA.P_CLOSE_CURSOR);
   END IF;
   RETURN(UNAPIGEN.DBERR_GENFAIL);
END ARCHIVEPTTOFILE;

BEGIN
   L_SEP:=UNAPIRA.P_INTERNAL_SEP;
END UNAPIRAPT;